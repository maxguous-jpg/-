# RULES — 家庭菜谱生成规则

> 约定：规则编号便于在代码中引用。例如 `R-BK-002`。

## A. 全局约束
- **R-GL-001（两周不重复）**：除“固定菜名”和“重点菜”外，菜名在两周窗口内不得重复出现。
- **R-GL-002（周内不重复）**：同一周内，除“固定菜名”和“重点菜”外，菜名不得重复。
- **R-GL-003（重点菜频控）**：重点菜也必须满足：
  - 不得在**同一日**重复（同餐内也不得重复）；
  - 不得**连续两日**出现；
  - **每周最多 3 天**出现。
- **R-GL-004（过敏回避）**：`people.allergies` 中出现的关键词命中菜名则禁止选用。
- **R-GL-005（固定菜名豁免）**：`豆浆 / 油条 / 豆腐脑 / 白米饭 / 火锅 / 烤肉` 不参与两周及周内去重，但仍需遵守“同餐不重复做法”等局部规则（见下）。

## B. 早餐（Breakfast）
- **R-BK-001（周一固定）**：周一早餐固定三项：`豆浆`、`油条`、`豆腐脑`。
- **R-BK-002（粥 vs 饮品二选一）**：周二至周日早餐在「**粥**」与「**饮品(二级=营养)**」二选一，不可同时出现（默认 50/50）。
- **R-BK-003（其他搭配）**：除 R-BK-001 当日外，早餐再添加：1×`干粮` + 1×`凉菜`。

## C. 午餐（Lunch）
- **R-LU-001（周二特例）**：根据周次 ID 尾号奇偶：
  - 尾数**偶**：午餐 2×`饺子`
  - 尾数**奇**：午餐 2×`面食`
- **R-LU-002（周五特例）**：与 R-LU-001 互补：
  - 尾数**偶**：2×`面食`
  - 尾数**奇**：2×`饺子`
- **R-LU-003（周六午餐空置）**：周六午餐无菜。
- **R-LU-004（常规日搭配）**：其余工作日午餐：
  1. 先选 1×`干粮` 作为**主食**；
  2. 若该干粮的**二级类别=“馅”**，则**不再添加主菜**（荤菜/海鲜/素菜）；  
     否则，从 `荤菜 / 海鲜 / 素菜` 三类中任选 1 道做**主菜**；
  3. 再补 `凉菜` 1 道、`汤/羹` 1 道、`水果` 1 道。
- **R-LU-005（主菜做法不冲突 / 同餐内）**：同一餐的主菜集合（荤菜/海鲜/素菜）中，菜名**不得出现相同“做法关键词”**：  
  `蒜蓉、香辣、干煸、干锅、醋溜、家常、酱焖、糖醋、红烧、蒜香、酱香、清蒸、宫保、咖喱`。

## D. 晚餐（Dinner）
- **R-DN-001（米饭需求日）**：周一/二/三/四/五/日（不含周六）晚餐自动附加 `白米饭`。
- **R-DN-002（周日晚特例）**：按周次尾号奇偶：
  - 尾数**奇**：`烤肉`
  - 尾数**偶**：`火锅`
  并额外添加 2×`水果`。
- **R-DN-003（周六晚复用周日晚方案）**：周六晚餐复用周日晚的常规 scheme（非烤肉/火锅那条）。
- **R-DN-004（主菜做法不冲突 / 同餐内）**：同午餐的 R-LU-005 规则适用于晚餐主菜（荤/海/素）。
- **R-DN-005（同日牛/羊二级类别不重复 / 仅荤菜）**：同一**日期**内，`荤菜` 的**二级类别**在 `牛肉 / 羊肉` 两个目标上**不得重复**（例如：同日已有“牛肉”，不得再来“牛肉”二级；羊肉同理）。

## E. 连带规则（次日午餐）
- **R-FL-001（触发列表）**：当日若出现触发菜名（如：`炖排骨`、`炖肘子`），记录触发。
- **R-FL-002（次日强制要求）**：若前一日触发，**次日午餐**需保证 1 道 `荤菜`：
  - 优先指定 `exactName=大锅菜`；
  - 若找不到 exactName，则选带 `fallbackTag=大锅菜` 的荤菜；
  - 否则随即挑选任一 `荤菜`（`allowRepeat=true` 仅作用于此兜底）。
- **R-FL-003（做法/牛羊限制仍生效）**：应用前仍需通过 R-LU-005 / R-DN-005 的过滤。

## F. 数据与优先级
- **R-DT-001（以菜名去重）**：导入菜谱库时，按 `name` 去重。
- **R-DT-002（标签“重点”逻辑）**：重点菜在**跨周/周内**去重中豁免，但应遵守 R-GL-003 的频控（同日不重复、不可连日、周内≤3天）。
- **R-DT-003（打分与随机）**：同分时使用微小随机（`+ Math.random() * 0.01`）打散选择。

## G. 分类与检索约定
- **R-CL-001**：一级类别关键集合：`饮品/粥/干粮/饭类/饺子/面食/荤菜/海鲜/素菜/凉菜/生鲜/汤/羹/甜品/水果/特殊`。
- **R-CL-002**：二级类别示例：`营养/馅/蒸/凉拌/鸡肉/牛肉/羊肉/鱼肉/贝类/豆制品/蔬菜/...`。
- **R-CL-003**：`listByCat(cat1)`、`listByCat2(cat1, cat2)` 为唯一合法检索口径（便于以后统一替换）。

（完）
